# ComfyUI 自定义节点指南

## 什么是自定义节点

ComfyUI 内置约 50+ 基础节点，自定义节点（Custom Nodes）是社区开发的扩展，提供额外功能：
- 新的图像处理能力
- 视频生成支持
- 更好的 UI 交互
- 第三方模型支持
- 工作流辅助工具

## 安装方式

### 方式一：ComfyUI Manager（推荐）

ComfyUI Manager 是最常用的节点管理器，提供一键安装：

**安装 Manager:**
```bash
cd ComfyUI/custom_nodes
git clone https://github.com/ltdrdata/ComfyUI-Manager.git
```

重启 ComfyUI 后，界面右侧会出现 "Manager" 按钮。

**使用 Manager:**
1. 点击 "Manager" 按钮
2. "Install Custom Nodes" - 浏览和搜索节点
3. "Install Missing Custom Nodes" - 自动安装工作流缺少的节点
4. "Update All" - 更新所有已安装节点

### 方式二：手动安装

```bash
cd ComfyUI/custom_nodes
git clone <节点仓库地址>
cd <节点目录>
pip install -r requirements.txt  # 如果有依赖
```

重启 ComfyUI 生效。

### 方式三：ComfyUI Desktop

Desktop 版本内置 Manager，直接在界面中操作即可。

## 常用节点包推荐

### 必装节点

| 节点包 | 功能 | 地址 |
|--------|------|------|
| ComfyUI-Manager | 节点管理器 | https://github.com/ltdrdata/ComfyUI-Manager |
| ComfyUI-Impact-Pack | 检测、分割、修复 | https://github.com/ltdrdata/ComfyUI-Impact-Pack |
| ComfyUI-Inspire-Pack | 区域提示词、批量处理 | https://github.com/ltdrdata/ComfyUI-Inspire-Pack |
| rgthree-comfy | 实用工具集 | https://github.com/rgthree/rgthree-comfy |
| ComfyUI_essentials | 基础工具增强 | https://github.com/cubiq/ComfyUI_essentials |

### ControlNet 相关

| 节点包 | 功能 |
|--------|------|
| comfyui_controlnet_aux | ControlNet 预处理器 (边缘检测、深度、姿态等) |
| ComfyUI-Advanced-ControlNet | 高级 ControlNet 控制 |

### 视频生成

| 节点包 | 功能 |
|--------|------|
| ComfyUI-VideoHelperSuite | 视频加载、保存、处理 |
| ComfyUI-AnimateDiff-Evolved | AnimateDiff 动画生成 |
| ComfyUI-Frame-Interpolation | 帧插值、慢动作 |

### 图像处理

| 节点包 | 功能 |
|--------|------|
| ComfyUI-WD14-Tagger | 图像标签识别 |
| ComfyUI_IPAdapter_plus | IP-Adapter 风格迁移 |
| ComfyUI-BRIA_AI-RMBG | 背景移除 |
| ComfyUI_UltimateSDUpscale | 分块放大 |

### UI 增强

| 节点包 | 功能 |
|--------|------|
| ComfyUI-Custom-Scripts | 自动排列、搜索增强 |
| cg-use-everywhere | 通配符连接 |
| ComfyUI-KJNodes | 各种实用工具 |

### 提示词工具

| 节点包 | 功能 |
|--------|------|
| ComfyUI_smZNodes | CLIP 分析工具 |
| ComfyUI-Easy-Use | 简化节点封装 |

## 节点资源网站

| 网站 | 地址 | 说明 |
|------|------|------|
| ComfyUI Manager 列表 | Manager 内置 | 最全的节点列表 |
| GitHub Topics | https://github.com/topics/comfyui-custom-node | GitHub 搜索 |
| Civitai Resources | https://civitai.com/tag/comfyui | 社区资源 |
| ComfyUI Wiki | https://comfyui-wiki.com/ | 节点文档 |

## 常见问题

### Q: 工作流提示缺少节点？

1. 使用 Manager → "Install Missing Custom Nodes"
2. 或查看错误信息中的节点名称，手动搜索安装

### Q: 安装后节点不显示？

1. 重启 ComfyUI
2. 检查 custom_nodes 目录下是否有该节点文件夹
3. 查看终端是否有报错

### Q: 节点报错 "No module named xxx"？

缺少 Python 依赖：
```bash
cd custom_nodes/节点目录
pip install -r requirements.txt
```

### Q: 如何更新节点？

**通过 Manager:**
- Manager → Update All

**手动更新:**
```bash
cd custom_nodes/节点目录
git pull
pip install -r requirements.txt  # 如果依赖更新
```

### Q: 如何卸载节点？

**通过 Manager:**
- Manager → 找到节点 → Uninstall

**手动卸载:**
```bash
rm -rf custom_nodes/节点目录
```

### Q: 节点冲突怎么办？

某些节点可能互相冲突，表现为：
- 启动报错
- 某些功能失效

解决方法：
1. 查看报错信息确定冲突节点
2. 禁用其中一个（重命名文件夹加 `.disabled`）
3. 或更新到最新版本

## 节点开发入门

如果想开发自己的节点：

### 基本结构

```
custom_nodes/
└── my_custom_node/
    ├── __init__.py       # 入口文件
    ├── nodes.py          # 节点定义
    └── requirements.txt  # 依赖（可选）
```

### 最简示例

```python
# __init__.py
from .nodes import MyNode

NODE_CLASS_MAPPINGS = {
    "MyNode": MyNode
}

NODE_DISPLAY_NAME_MAPPINGS = {
    "MyNode": "My Custom Node"
}

__all__ = ['NODE_CLASS_MAPPINGS', 'NODE_DISPLAY_NAME_MAPPINGS']
```

```python
# nodes.py
class MyNode:
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "text": ("STRING", {"default": "Hello"}),
            }
        }

    RETURN_TYPES = ("STRING",)
    FUNCTION = "process"
    CATEGORY = "My Nodes"

    def process(self, text):
        return (text.upper(),)
```

### 开发资源

- [ComfyUI 节点开发文档](https://docs.comfy.org/essentials/custom_node_overview)
- [ComfyUI 源码 nodes.py](https://github.com/comfyanonymous/ComfyUI/blob/master/nodes.py) - 官方节点参考
- 本仓库 [study/03-节点系统-nodes.py.md](../study/03-节点系统-nodes.py.md) - 节点系统源码分析

## 推荐安装组合

### 基础组合（新手）

```
ComfyUI-Manager
ComfyUI-Impact-Pack
rgthree-comfy
comfyui_controlnet_aux
```

### 完整组合（进阶）

```
ComfyUI-Manager
ComfyUI-Impact-Pack
ComfyUI-Inspire-Pack
rgthree-comfy
ComfyUI_essentials
comfyui_controlnet_aux
ComfyUI-Advanced-ControlNet
ComfyUI_IPAdapter_plus
ComfyUI-VideoHelperSuite
ComfyUI-WD14-Tagger
ComfyUI-Custom-Scripts
```

## 下一步

- 返回 [工作流入门](02-工作流入门.md) 学习基础操作
- 查看 [模型指南](03-模型指南.md) 了解模型配置

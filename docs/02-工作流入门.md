# ComfyUI 工作流入门

## 界面介绍

### 主界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  菜单栏: 队列 | 工作流操作 | 设置                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                        画布区域                              │
│                                                             │
│    ┌─────────┐         ┌─────────┐         ┌─────────┐     │
│    │ 节点 A  │────────▶│ 节点 B  │────────▶│ 节点 C  │     │
│    └─────────┘         └─────────┘         └─────────┘     │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  状态栏: 执行进度 | 显存使用                                   │
└─────────────────────────────────────────────────────────────┘
```

### 基本操作

| 操作 | 快捷键/方式 |
|------|------------|
| 添加节点 | 双击画布 / 右键菜单 |
| 删除节点 | 选中后按 Delete |
| 复制节点 | Ctrl+C |
| 粘贴节点 | Ctrl+V |
| 连接节点 | 拖拽输出端口到输入端口 |
| 断开连接 | 右键连线 / 拖走连线 |
| 画布缩放 | 滚轮 |
| 画布平移 | 中键拖拽 / 空格+左键 |
| 运行工作流 | Queue Prompt 按钮 |
| 搜索节点 | 双击画布后输入 |

## 官方模板

ComfyUI 内置了官方工作流模板，是新手学习的最佳起点。

### 使用模板

1. 点击界面上的 **"Templates"（模板）** 按钮
2. 选择一个模板分类
3. 点击模板加载到画布

### 模板分类

| 分类 | 内容 |
|------|------|
| Image Generation | 基础文生图、图生图 |
| SDXL | SDXL 模型工作流 |
| SD3 / Flux | 新架构模型工作流 |
| ControlNet | 各种控制类型示例 |
| Video | 视频生成工作流 |
| Inpainting | 局部重绘示例 |
| LoRA | LoRA 加载和使用 |
| Upscale | 图片放大工作流 |

### 模板来源

模板由官方包 `comfyui-workflow-templates` 提供，随 ComfyUI 一起安装。

如果模板按钮不显示或为空，检查是否安装：
```bash
pip install comfyui-workflow-templates
```

## 节点系统

### 节点结构

```
┌────────────────────────────┐
│       节点名称              │
├────────────────────────────┤
│ ● 输入1                    │  ← 输入端口 (左侧)
│ ● 输入2                    │
├────────────────────────────┤
│   参数1: [值]              │  ← 可调节参数
│   参数2: [值]              │
├────────────────────────────┤
│                   输出1 ●  │  ← 输出端口 (右侧)
│                   输出2 ●  │
└────────────────────────────┘
```

### 数据类型 (颜色区分)

| 颜色 | 类型 | 说明 |
|------|------|------|
| 🟣 紫色 | LATENT | 潜空间数据 |
| 🔵 蓝色 | IMAGE | 图像数据 |
| 🟠 橙色 | CONDITIONING | 条件 (提示词编码) |
| 🟢 绿色 | MODEL | 模型 |
| 🔴 红色 | CLIP | 文本编码器 |
| 🟡 黄色 | VAE | 图像编码/解码器 |
| ⚪ 白色 | MASK | 蒙版 |

## 基础工作流

### 文生图 (Text to Image)

最基础的工作流，从文字生成图片：

```
加载模型 ──┬──▶ CLIP编码(正向) ──┐
          │                      │
          ├──▶ CLIP编码(负向) ──┼──▶ KSampler ──▶ VAE解码 ──▶ 保存图片
          │                      │
          └──▶ 空白Latent ───────┘
```

**核心节点:**

1. **Load Checkpoint** - 加载主模型
   - 输出: MODEL, CLIP, VAE

2. **CLIP Text Encode** - 文本编码
   - 正向提示词: 想要的内容
   - 负向提示词: 不想要的内容

3. **Empty Latent Image** - 创建空白画布
   - width/height: 图片尺寸
   - batch_size: 批量数量

4. **KSampler** - 采样器 (核心)
   - seed: 随机种子
   - steps: 采样步数 (20-30)
   - cfg: 提示词强度 (7-8)
   - sampler_name: 采样算法
   - scheduler: 调度器

5. **VAE Decode** - 解码为图片

6. **Save Image** - 保存结果

### 图生图 (Image to Image)

从已有图片生成新图片：

```
加载图片 ──▶ VAE编码 ──┐
                       │
加载模型 ──┬──▶ CLIP编码 ──┼──▶ KSampler ──▶ VAE解码 ──▶ 保存
          │            │
          └────────────┘
```

**关键参数:**
- denoise: 去噪强度 (0.0-1.0)
  - 0.3-0.5: 轻微修改
  - 0.6-0.8: 中等变化
  - 0.9-1.0: 几乎重绘

### ControlNet 工作流

用控制图引导生成：

```
控制图 ──▶ ControlNet应用 ──┐
                           │
原图/空白 ──▶ VAE编码 ───────┼──▶ KSampler ──▶ 输出
                           │
提示词 ──▶ CLIP编码 ────────┘
```

**常用控制类型:**
- Canny: 边缘检测
- Depth: 深度图
- OpenPose: 姿态
- Lineart: 线稿
- Scribble: 涂鸦

### LoRA 加载

给模型添加风格/角色：

```
Load Checkpoint ──▶ Load LoRA ──▶ KSampler
                        │
                    strength_model: 模型强度
                    strength_clip: CLIP强度
```

多个 LoRA 可以串联使用。

## 参数详解

### KSampler 参数

| 参数 | 说明 | 推荐值 |
|------|------|--------|
| seed | 随机种子，相同种子产生相同结果 | 任意 |
| steps | 采样步数，越多越精细但越慢 | 20-30 |
| cfg | 提示词遵循度，越高越遵循 | 6-8 |
| sampler_name | 采样算法 | euler, dpmpp_2m |
| scheduler | 调度器 | normal, karras |
| denoise | 去噪强度 (图生图用) | 0.5-0.8 |

### 常用采样器

| 采样器 | 特点 |
|--------|------|
| euler | 快速，基础 |
| euler_ancestral | 多样性高 |
| dpmpp_2m | 质量好，推荐 |
| dpmpp_2m_sde | 细节丰富 |
| dpmpp_3m_sde | 最新，效果好 |
| uni_pc | 快速收敛 |

### 调度器

| 调度器 | 特点 |
|--------|------|
| normal | 标准 |
| karras | 更平滑的噪声 |
| exponential | 指数衰减 |
| sgm_uniform | 统一步长 |

## 提示词技巧

### 基本语法

```
# 权重语法
(keyword)      # 1.1x 权重
((keyword))    # 1.21x 权重
(keyword:1.5)  # 指定 1.5x 权重

# 示例
a beautiful girl, (long hair:1.2), ((blue eyes)), smile
```

### 结构化提示词

```
# 主体
1girl, solo, standing

# 外观
long blonde hair, blue eyes, fair skin

# 服装
white dress, ribbon

# 动作/表情
smile, looking at viewer

# 环境
outdoor, garden, sunlight

# 画面质量
masterpiece, best quality, highly detailed
```

### 负向提示词模板

```
# 通用负向
lowres, bad anatomy, bad hands, text, error, missing fingers,
extra digit, fewer digits, cropped, worst quality, low quality,
normal quality, jpeg artifacts, signature, watermark, username, blurry

# 针对人物
deformed, ugly, mutilated, disfigured, extra limbs,
face cut, head cut, extra fingers, extra arms
```

## 工作流管理

### 保存工作流

1. 菜单 → Save / Save As
2. 保存为 .json 文件
3. 也可以嵌入到生成的 PNG 图片中

### 加载工作流

1. 菜单 → Load
2. 直接拖拽 .json 文件到画布
3. 拖拽带工作流的 PNG 图片

### 工作流分享与获取

**导出方式:**
- 导出为 .json 文件
- 带工作流的 PNG 图片 (元数据嵌入)

**工作流资源网站:**

| 网站 | 地址 | 特点 |
|------|------|------|
| ComfyUI Examples | https://comfyanonymous.github.io/ComfyUI_examples/ | 官方示例，基础教学 |
| OpenArt | https://openart.ai/workflows | 最大的工作流平台，分类齐全 |
| Civitai | https://civitai.com/models?types=Workflows | 模型配套工作流，社区活跃 |
| ComfyWorkflows | https://comfyworkflows.com/ | 工作流分享，支持在线预览 |
| Comfy.icu | https://comfy.icu/ | 工作流搜索引擎 |
| RunComfy | https://www.runcomfy.com/workflows | 云端运行+工作流库 |
| YouML | https://youml.com/workflows | 工作流市场 |

**国内平台:**

| 网站 | 地址 | 特点 |
|------|------|------|
| LiblibAI | https://www.liblib.art/workflows | 国内最大，中文友好 |
| 吐司 Tusi.Art | https://tusi.art/ | 国内平台，有工作流分享 |
| 小红书 | 搜索 "ComfyUI 工作流" | 大量中文教程 |
| B站 | 搜索 "ComfyUI" | 视频教程，带工作流下载 |
| 抖音 | 搜索 "ComfyUI" | 短视频教程 |

**GitHub 资源:**

| 仓库 | 地址 | 内容 |
|------|------|------|
| ComfyUI-workflows | https://github.com/ai-dock/comfyui-workflows | 常用工作流集合 |
| Comfy-WF | https://github.com/NyaamZ/Comfy-WF | 整理好的工作流 |
| awesome-comfyui | https://github.com/henryamster/awesome-comfyui | 资源汇总 |

**使用他人工作流:**
1. 下载 .json 文件或带工作流的图片
2. 拖拽到 ComfyUI 画布
3. 如果提示缺少节点，需要安装对应的自定义节点
4. 如果提示缺少模型，需要下载对应模型

## 常用技巧

### 1. 批量生成

Empty Latent Image 的 batch_size 设为多个，一次生成多张。

### 2. 高清修复 (Hires Fix)

```
第一次采样 ──▶ 放大 ──▶ 第二次采样 (低 denoise)
```

使用 Upscale Latent 或图片放大节点。

### 3. 局部重绘 (Inpainting)

1. 加载原图
2. 创建蒙版 (白色区域重绘)
3. 使用 Set Latent Noise Mask

### 4. 固定种子复现

记录 seed 值，可以复现相同结果。
点击 seed 输入框右侧的骰子切换随机/固定模式。

### 5. 预览节点

添加 Preview Image 节点可以查看中间结果。

## 下一步

- 了解 [模型使用指南](03-模型指南.md) 选择合适的模型
- 查看 [性能优化](04-性能优化.md) 提升生成速度

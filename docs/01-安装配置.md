# ComfyUI 安装配置指南

## 系统要求

### 硬件要求
- **显卡**: NVIDIA GPU (推荐 RTX 20 系列以上)
  - 最低 4GB 显存 (基础 SD 1.5)
  - 推荐 8GB+ (SDXL)
  - 12GB+ (Flux, 视频模型)
- **内存**: 16GB+ RAM
- **硬盘**: 50GB+ 可用空间 (模型文件较大)

### 软件要求
- Python 3.10 - 3.12
- Git
- CUDA 工具包 (NVIDIA GPU)

## 安装方式

### 方式一: 便携版 (推荐新手)

1. 下载 [ComfyUI 便携版](https://github.com/comfyanonymous/ComfyUI/releases)
2. 解压到任意目录
3. 运行 `run_nvidia_gpu.bat`

### 方式二: 手动安装

```bash
# 克隆仓库
git clone https://github.com/comfyanonymous/ComfyUI.git
cd ComfyUI

# 创建虚拟环境 (推荐)
python -m venv venv
venv\Scripts\activate  # Windows
# source venv/bin/activate  # Linux/Mac

# 安装 PyTorch (根据 CUDA 版本选择)
# CUDA 12.1
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
# CUDA 11.8
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# 安装依赖
pip install -r requirements.txt

# 启动
python main.py
```

### 方式三: ComfyUI Desktop

官方桌面版，自带环境，开箱即用：
- [下载地址](https://www.comfy.org/download)

## 代理配置

### 方式一: 环境变量

```bash
# Windows CMD
set HTTP_PROXY=http://127.0.0.1:7890
set HTTPS_PROXY=http://127.0.0.1:7890

# Windows PowerShell
$env:HTTP_PROXY="http://127.0.0.1:7890"
$env:HTTPS_PROXY="http://127.0.0.1:7890"

# Linux/Mac
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890
```

### 方式二: ComfyUI Desktop 代理设置

Desktop 版本需要修改配置文件：

**Windows**: `%APPDATA%\ComfyUI\extra_models_config.yaml`
**Mac**: `~/Library/Application Support/ComfyUI/extra_models_config.yaml`

或者在启动时设置环境变量。

### HuggingFace 镜像

国内下载 HuggingFace 模型可使用镜像：

```bash
# 设置 HF 镜像
set HF_ENDPOINT=https://hf-mirror.com
# 或
set HF_ENDPOINT=https://aifasthub.com
```

## 目录结构

```
ComfyUI/
├── models/                 # 模型文件
│   ├── checkpoints/       # 主模型 (SD, SDXL, Flux)
│   ├── vae/               # VAE 模型
│   ├── loras/             # LoRA 模型
│   ├── controlnet/        # ControlNet 模型
│   ├── clip/              # CLIP 文本编码器
│   ├── clip_vision/       # CLIP 视觉编码器
│   ├── unet/              # 单独的 UNet 模型
│   └── embeddings/        # Textual Inversion 嵌入
├── input/                 # 输入图片
├── output/                # 输出图片
├── custom_nodes/          # 自定义节点
└── user/                  # 用户数据
    └── default/
        └── workflows/     # 保存的工作流
```

## 启动参数

```bash
python main.py [参数]
```

常用参数:

| 参数 | 说明 |
|------|------|
| `--listen` | 允许外部访问 (默认只能本地) |
| `--port 8188` | 指定端口 |
| `--cpu` | 仅使用 CPU (很慢) |
| `--lowvram` | 低显存模式 (4-6GB 显存) |
| `--normalvram` | 标准显存模式 |
| `--highvram` | 高显存模式 (不自动卸载) |
| `--gpu-only` | 所有操作在 GPU |
| `--disable-xformers` | 禁用 xformers |
| `--preview-method auto` | 预览方式 (auto/latent2rgb/taesd) |
| `--front-end-version` | 指定前端版本 |

### 显存相关选项

```bash
# 4GB 显存
python main.py --lowvram

# 6GB 显存
python main.py --normalvram

# 12GB+ 显存，追求速度
python main.py --highvram --gpu-only
```

## 常见问题

### Q: 启动后浏览器打不开?

默认地址: http://127.0.0.1:8188

如果端口被占用，尝试:
```bash
python main.py --port 8189
```

### Q: 显存不足 (Out of Memory)?

1. 使用 `--lowvram` 参数启动
2. 减小图片尺寸
3. 减少批量大小 (batch size)
4. 关闭其他占用显存的程序

### Q: 模型加载失败?

检查:
1. 模型文件是否完整 (下载是否中断)
2. 模型放置目录是否正确
3. 模型格式是否支持 (.safetensors, .ckpt)

### Q: 自定义节点报错?

```bash
# 进入 custom_nodes 目录
cd custom_nodes/节点目录

# 安装依赖
pip install -r requirements.txt
```

### Q: 如何更新?

```bash
cd ComfyUI
git pull
pip install -r requirements.txt
```

自定义节点也需要单独更新:
```bash
cd custom_nodes/节点名
git pull
```

### Q: CUDA 错误?

确保:
1. NVIDIA 驱动是最新的
2. PyTorch CUDA 版本与驱动匹配
3. 尝试重新安装 PyTorch

```bash
# 查看 CUDA 版本
nvidia-smi

# 重新安装 PyTorch
pip uninstall torch torchvision torchaudio
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

## 下一步

安装完成后，请阅读 [工作流入门](02-工作流入门.md) 开始使用 ComfyUI。
